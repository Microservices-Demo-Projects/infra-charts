# Default values for hashicorp-vault.
# This is a wrapper chart, so we primarily configure the subchart 'vault'.

vault:
  global:
    openshift: true

  server:
    # Standalone mode for local development (Simpler, no Raft HA)
    ha:
      enabled: false

    # Explicitly set image with full URL to avoid Red Hat registry issues on some clusters
    # NOTE: This Red Hat UBI image is optimized for OpenShift. 
    # For standard Kubernetes, override this to 'hashicorp/vault' and tag '1.21.2' to avoid security context issues.
    image:
      repository: registry.connect.redhat.com/hashicorp/vault
      tag: "1.21.2-ubi"

    dataStorage:
      size: 5Gi # Default is 10Gi

    # Extra volumes to mount the TLS secret
    # The chart auto-mounts these at /vault/userconfig/<name>
    extraVolumes:
      - type: secret
        name: vault-tls

    # Configure the standalone server definition
    standalone:
      config: |
        ui = true

        listener "tcp" {
          tls_disable = 0 # Enable TLS
          address = "0.0.0.0:8200"
          cluster_address = "0.0.0.0:8201"
          tls_cert_file = "/vault/userconfig/vault-tls/tls.crt"
          tls_key_file = "/vault/userconfig/vault-tls/tls.key"
          tls_client_ca_file = "/vault/userconfig/vault-tls/ca.crt" # Optional if client auth is needed
        }

        storage "file" {
          path = "/vault/data"
        }

    # Set environment variables for the Vault CLI ensuring it trusts the new cert
    extraEnvironmentVars:
      VAULT_ADDR: https://127.0.0.1:8200
      VAULT_CACERT: /vault/userconfig/vault-tls/ca.crt # Assumes ca.crt is in the secret, otherwise use tls.crt temporarily or configure issuer

    # OpenShift Route configuration
    route:
      enabled: true
      host: "" # Leave empty to autogenerate or specify a hostname
      tls:
        termination: PASSTHROUGH # Use PASSTHROUGH for end-to-end TLS

    # Security Context Constraints (SCC) are handled by the chart with global.openshift: true
    # but we might need to ensure the service account has permissions.
    # The official chart handles SCC binding if global.openshift is true.

  injector:
    enabled: false # Disable agent injector by default to keep it simple, enable if needed
    
  ui:
    enabled: true
    serviceType: ClusterIP
    serviceNodePort: null
    externalPort: 8200
