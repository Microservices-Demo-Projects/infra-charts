# PostgreSQL Wrapper Chart

This chart is a wrapper around the **Bitnami PostgreSQL** Helm chart.

This wrapper configures PostgreSQL for **OpenShift by default**, integrates with **cert-manager** for TLS, and enables **HashiCorp Vault** + **External Secrets Operator** for secure password management and dynamic database credentials.

For standard Kubernetes usage, see the section below for required adjustments.

---

# Installation Sequence

For a full infrastructure deployment (recommended order):

1. [Cert-Manager](../cert-manager/README.md)  
2. [Headlamp](../headlamp/README.md) (optional for OpenShift)  
3. [HashiCorp Vault](../hashicorp-vault/README.md)  
4. [External Secrets](../external-secrets/README.md)  
5. [Stakater Reloader](../skater-reloader/README.md)  
6. **PostgreSQL (Current)**

---

# Overview

This wrapper chart provides:

- **TLS-enabled PostgreSQL** using a cert-manager Certificate  
- **Root password stored securely in Vault KV** and synced via ExternalSecret  
- **A rotating privileged PostgreSQL user** using Vault's Database Secrets Engine  
- **OpenShift-first behavior**, with compatibility notes for standard Kubernetes  
- Controlled values passed under `postgresql:` as per Helm wrapper best practices

---

# Prerequisites

### OpenShift (default environment)

- A running OpenShift cluster  
- cert-manager installed with a `ClusterIssuer` named `demo-ca`  
- Vault installed, initialized, and unsealed  
- External Secrets Operator installed **including CRDs**  
- A functional `ClusterSecretStore` named `local-vault-backend`  
- A working StorageClass  
- A Vault KV secret for root password created manually (steps below)

### Standard Kubernetes Requirements

- cert-manager installed  
- Vault and ESO installed  
- No OpenShift SCC/Route assumptions  
- `kubectl port-forward` used instead of Routes  
- Same Vault setup applies

---

# TLS Configuration

This chart deploys a cert-manager `Certificate` for PostgreSQL:

- Secret: `postgres-tls`
- DNS names:
  - `postgres-postgresql`
  - `postgres-postgresql.<namespace>.svc`
  - `postgres-postgresql.<namespace>.svc.cluster.local`

Bitnami PostgreSQL consumes TLS via:

```yaml
postgresql:
  tls:
    enabled: true
    autoGenerated: false
    existingSecret: postgres-tls
```

This ensures:

- TLS enforcement  
- Encrypted connections for all apps  
- Certificates issued by demo-ca and trusted by internal services  

---

# Vault Integration

This chart provides **two ExternalSecrets**:

1. A static *root password* synced from Vault KV  
2. A dynamic *privileged rotating user* sourced from Vault’s DB Secrets Engine  

Both resources are managed by the External Secrets Operator and included in this chart.

---

## 1. PostgreSQL Root Password (Static via Vault KV)

**Manual Preparation (required before installing this chart):**

```bash
vault kv put kv/db/postgres-root password=$(openssl rand -base64 32)
```

This creates the root password in Vault KV at:

```
kv/db/postgres-root
```

During installation, this chart deploys:

```yaml
ExternalSecret: postgres-root-password
Secret: postgres-root-password (key: password)
```

PostgreSQL consumes the root password using:

```yaml
postgresql:
  auth:
    existingSecret: postgres-root-password
    existingSecretPasswordKey: password
    enablePostgresUser: true
```

---

## 2. Rotating Privileged PostgreSQL User (Dynamic)

Vault dynamic credentials are issued via:

```
database/postgres/creds/privileged-user
```

### Step A — Enable Vault DB Engine

```bash
vault secrets enable -path=database/postgres database
```

### Step B — Configure DB Connection (TLS)

```bash
vault write database/postgres/config/connection \
  plugin_name=postgresql-database-plugin \
  allowed_roles="privileged-user" \
  connection_url="postgresql://{{username}}:{{password}}@postgres-postgresql.<namespace>.svc.cluster.local:5432/postgres?sslmode=require" \
  username="postgres" \
  password=$(vault kv get -field=password kv/db/postgres-root)
```

Vault will interpolate `{{username}}` and `{{password}}` during login.

### Step C — Create the Rotating Role

```bash
vault write database/postgres/roles/privileged-user \
  db_name=connection \
  creation_statements="CREATE ROLE \"{{name}}\" WITH LOGIN PASSWORD '{{password}}'; \
      GRANT ALL PRIVILEGES ON ALL TABLES IN SCHEMA public TO \"{{name}}\"; \
      GRANT ALL PRIVILEGES ON SCHEMA public TO \"{{name}}\"; \
      ALTER DEFAULT PRIVILEGES IN SCHEMA public GRANT ALL PRIVILEGES ON TABLES TO \"{{name}}\"; \
      ALTER DEFAULT PRIVILEGES IN SCHEMA public GRANT ALL PRIVILEGES ON SEQUENCES TO \"{{name}}\";" \
  default_ttl=1h \
  max_ttl=24h
```

### Step D — ExternalSecret (auto-installed)

This chart installs:

```yaml
ExternalSecret: postgres-privileged-user
Secret: postgres-rotating-creds
Keys:
  - username
  - password
```

App workloads can mount this secret to retrieve valid credentials on every rotation.

---

# Installation (OpenShift)

### 1. Navigate to the directory
```bash
cd infra-charts/postgres
```

### 2. Add Bitnami repo
```bash
helm repo add bitnami https://charts.bitnami.com/bitnami
helm repo update
```

### 3. Pull dependency
```bash
helm dependency update .
```

### 4. Install chart
Ensure Vault + ESO are ready and the root password secret exists in Vault.

```bash
oc new-project postgres || true

helm upgrade --install postgres . \
  --namespace postgres \
  --create-namespace
```

---

# Verification

### Check PostgreSQL pod
```bash
oc get pods -n postgres
```

### Check TLS certificate and secret
```bash
oc get certificate postgres-tls -n postgres
oc get secret postgres-tls -n postgres
```

### Verify ExternalSecrets synced
```bash
oc get externalsecret -n postgres
oc get secret postgres-root-password -n postgres
oc get secret postgres-rotating-creds -n postgres
```

---

# Retrieving the Root Password

```bash
oc get secret postgres-root-password -n postgres \
  -o jsonpath='{.data.password}' | base64 -d
```

---

# Connecting to PostgreSQL (TLS Enabled)

Port-forward:

```bash
oc port-forward svc/postgres-postgresql -n postgres 5432:5432
```

Connect:

```bash
psql "host=127.0.0.1 sslmode=require user=postgres password=$(oc get secret postgres-root-password -n postgres -o jsonpath='{.data.password}' | base64 -d)"
```

---

# Using the Rotating Privileged User

```yaml
env:
  - name: DB_USER
    valueFrom:
      secretKeyRef:
        name: postgres-rotating-creds
        key: username
  - name: DB_PASSWORD
    valueFrom:
      secretKeyRef:
        name: postgres-rotating-creds
        key: password
```

---

# Pause & Resume

To pause:
```bash
oc scale statefulset postgres-postgresql --replicas=0 -n postgres
```

To resume:
```bash
oc scale statefulset postgres-postgresql --replicas=1 -n postgres
```

---

# Cleanup

```bash
helm uninstall postgres -n postgres
oc delete project postgres
```

---

# Next Steps

You can now integrate PostgreSQL with:

- External Secrets Operator (root + dynamic user)
- HashiCorp Vault (KV + Database Engine)
- Applications requiring encrypted, auto-rotated DB credentials